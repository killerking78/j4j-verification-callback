import fetch from "node-fetch";

export default {
  async fetch(request) {
    const url = new URL(request.url);

    // Root route
    if (url.pathname === "/") {
      return new Response("Discord OAuth Worker running!", { status: 200 });
    }

    // Callback route
    if (url.pathname === "/callback") {
      const code = url.searchParams.get("code");
      const state = url.searchParams.get("state"); // optional

      if (!code) return new Response("Missing code", { status: 400 });

      // Exchange code for token
      const form = new URLSearchParams();
      form.append("client_id", CLIENT_ID);
      form.append("client_secret", CLIENT_SECRET);
      form.append("grant_type", "authorization_code");
      form.append("code", code);
      form.append("redirect_uri", REDIRECT_URI);
      form.append("scope", "identify guilds.join guilds");

      const tokenRes = await fetch("https://discord.com/api/oauth2/token", {
        method: "POST",
        body: form,
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
      });

      const tokenData = await tokenRes.json();
      if (!tokenData.access_token) {
        return new Response("Authorization failed: " + JSON.stringify(tokenData), { status: 400 });
      }

      const accessToken = tokenData.access_token;

      // Fetch user info
      const userRes = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      const user = await userRes.json();

      // Optional: auto-add to guild
      if (GUILD_ID && BOT_TOKEN) {
        await fetch(`https://discord.com/api/guilds/${GUILD_ID}/members/${user.id}`, {
          method: "PUT",
          headers: {
            Authorization: `Bot ${BOT_TOKEN}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ access_token: accessToken }),
        });
      }

      return new Response(`Authorization successful! Welcome ${user.username}#${user.discriminator}`, { status: 200 });
    }

    return new Response("Not found", { status: 404 });
  }
};
